
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  plan          String?
  wanted_plan   String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]
  members       Member[]
  invitations   Invitation[]

  @@unique([email])
  @@map("user")
}

model Session {
  id                   String   @id
  expiresAt            DateTime
  token                String
  createdAt            DateTime
  updatedAt            DateTime
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Organization {
  id                       String       @id
  name                     String
  slug                     String
  logo                     String?
  createdAt                DateTime
  metadata                 String?
  members                  Member[]
  invitations              Invitation[]

  // Scheduling Settings
  defaultAppointmentLength Int?         @default(30)
  bufferTime               Int?         @default(15)
  bookingWindow            Int?         @default(30)
  cancellationPolicy       Int?         @default(24)

  // Notification Settings
  emailReminders           Boolean?     @default(true)
  reminderTiming           Int?         @default(24)
  appointmentConfirmation  Boolean?     @default(true)
  appointmentReminder      Boolean?     @default(true)
  appointmentCancellation  Boolean?     @default(true)
  patientRegistration      Boolean?     @default(false)

  // Metric/Unit Settings
  weightUnit               String?      @default("kg")      // kg, lbs
  heightUnit               String?      @default("cm")      // cm, ft_in (feet & inches), m (meters)
  temperatureUnit          String?      @default("celsius") // celsius, fahrenheit

  // Automated Report Settings
  autoReportsEnabled       Boolean?     @default(true)
  lastReportGeneratedAt    DateTime?

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  createdAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Patient {
  id             String          @id @default(cuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  dateOfBirth    DateTime?
  address        String?
  organizationId String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  appointments   Appointment[]
  medicalRecords MedicalRecord[]

  @@map("patient")
}

model MedicalRecord {
  id             String    @id @default(cuid())
  patientId      String
  patient        Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointmentId  String?
  appointment    Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  
  // Visit Information
  visitDate      DateTime  @default(now())
  visitType      String    // consultation, follow-up, procedure, emergency
  chiefComplaint String?   // Main reason for visit
  
  // Clinical Notes
  diagnosis      String?
  symptoms       String?
  treatment      String?
  prescription   String?
  notes          String?
  
  // Vitals (optional)
  bloodPressure  String?
  heartRate      Int?
  temperature    Float?
  weight         Float?
  height         Float?
  
  // Follow-up
  followUpDate   DateTime?
  followUpNotes  String?
  
  // Metadata
  createdBy      String    // Doctor/staff who created the record
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("medical_record")
}

model Appointment {
  id              String          @id @default(cuid())
  patientId       String
  patient         Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctorId        String?         // User ID of the doctor
  doctorName      String
  time            DateTime
  duration        Int             @default(30)
  type            String          // consultation, follow-up, procedure, checkup
  status          String          @default("scheduled") // scheduled, confirmed, completed, cancelled, no-show
  notes           String?
  organizationId  String?
  
  // Reminder tracking
  reminderSent    Boolean         @default(false)
  reminderSentAt  DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  medicalRecords  MedicalRecord[]

  @@map("appointment")
}

// Track email usage for billing limits
model EmailLog {
  id             String   @id @default(cuid())
  organizationId String
  recipientEmail String
  emailType      String   // appointment_reminder, appointment_confirmation, etc.
  subject        String
  status         String   @default("sent") // sent, failed, bounced
  appointmentId  String?
  sentAt         DateTime @default(now())
  
  @@index([organizationId, sentAt])
  @@map("email_log")
}